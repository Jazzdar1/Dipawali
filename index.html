
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DarTV - Speed & Quality</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- RESET --- */
        :root { --bg: #050505; --side: #0a0a0a; --primary: #3b82f6; --accent: #dc2626; --border: 1px solid #222; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- TICKERS --- */
        .ticker-box { height: 30px; display: flex; flex-shrink: 0; z-index: 50; overflow: hidden; background: #111; border-bottom: 1px solid #333; }
        .t-lbl { background: var(--accent); color: #fff; font-weight: 900; font-size: 11px; padding: 0 10px; display: flex; align-items: center; z-index: 2; box-shadow: 4px 0 10px #000; }
        .t-blue { background: #0284c7; }
        .t-wrap { flex: 1; position: relative; display: flex; align-items: center; overflow: hidden; }
        .t-txt { white-space: nowrap; font-size: 13px; font-weight: 600; display: inline-block; padding-left: 100%; animation: scroll 35s linear infinite; color: #fca5a5; }
        .tx-blue { color: #bae6fd; }
        @keyframes scroll { 100% { transform: translateX(-100%); } }

        /* --- LAYOUT --- */
        .app-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        .sidebar { width: 280px; min-width: 280px; background: var(--side); border-right: var(--border); display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s; }
        .brand { padding: 15px; font-size: 24px; font-weight: 900; border-bottom: var(--border); display: flex; align-items: center; gap: 10px; background: #000; }
        .brand span { color: var(--primary); }

        .tools { padding: 10px; background: #111; border-bottom: var(--border); }
        .mode-row { display: flex; background: #000; border: 1px solid #333; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 8px; text-align: center; cursor: pointer; font-size: 12px; font-weight: bold; color: #777; transition: 0.2s; }
        .mode-btn.active { background: var(--primary); color: #fff; }
        .mode-btn:hover:not(.active) { background: #222; }

        .btn-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .tool-btn { flex: 1; background: #222; border: 1px solid #333; color: #ccc; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 11px; text-align: center; }
        .tool-btn:hover { background: #333; color: #fff; }
        
        .cors-toggle { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; cursor: pointer; margin-bottom: 5px; }
        .cors-ind { width: 8px; height: 8px; background: #444; border-radius: 50%; }

        .tabs { display: flex; border-bottom: var(--border); }
        .tab { flex: 1; padding: 10px; background: transparent; color: #777; border: none; cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent; font-size: 11px; text-transform: uppercase; }
        .tab.active { color: white; border-bottom-color: var(--primary); background: #151515; }
        
        .search-box { padding: 8px; border-bottom: var(--border); }
        .inp { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 6px; border-radius: 4px; font-size: 11px; }
        
        .nav-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .nav-item { padding: 10px 15px; border-bottom: 1px solid #1a1a1a; cursor: pointer; color: #ccc; font-size: 13px; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: #222; color: white; }

        /* --- MAIN AREA --- */
        .main { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; overflow: hidden; }
        
        /* PLAYER */
        .player-stage { height: 55%; display: flex; flex-direction: column; position: relative; flex-shrink: 0; background: #000; }
        .video-box { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; background: #000; }
        
        /* OVERLAYS (Logo & Viz) */
        .overlay-center { position: absolute; inset: 0; background: #000; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; opacity: 1; pointer-events: none; }
        .overlay-center.hidden { opacity: 0; }
        .big-logo { font-size: 40px; font-weight: 900; letter-spacing: -2px; margin-bottom: 10px; }
        .big-logo span { color: var(--primary); }
        .loader { width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .radio-viz { position: absolute; inset: 0; background: radial-gradient(circle, #222, #000); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 40; }
        .viz-bars { display: flex; gap: 5px; height: 50px; align-items: flex-end; margin-top: 20px; }
        .bar { width: 8px; background: var(--primary); animation: bounce 1s infinite; }
        @keyframes bounce { 0%,100% { height: 10px; } 50% { height: 50px; } }

        /* BROWSER */
        .browser { flex: 1; display: flex; flex-direction: column; background: #050505; min-height: 0; }
        .controls { height: 45px; background: #111; border-bottom: var(--border); display: flex; align-items: center; padding: 0 10px; gap: 10px; flex-shrink: 0; }
        .meta { display: flex; align-items: center; gap: 8px; overflow: hidden; min-width: 100px; flex: 1; }
        .meta img { width: 24px; height: 24px; background: #222; border-radius: 3px; object-fit: contain; }
        .meta-info div:first-child { font-weight: bold; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta-info div:last-child { font-size: 10px; color: var(--primary); }
        
        .actions { display: flex; gap: 5px; }
        .act-btn { background: #222; border: 1px solid #333; color: #ccc; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .act-btn:hover { border-color: var(--primary); color: #fff; }
        
        .quality-select { background: #222; color: #fff; border: 1px solid #333; padding: 4px; border-radius: 4px; font-size: 11px; outline: none; cursor: pointer; display: none; }

        .rail { padding: 8px; background: #0a0a0a; border-bottom: var(--border); display: flex; gap: 8px; overflow-x: auto; flex-shrink: 0; }
        .chip { padding: 4px 12px; background: #222; border: 1px solid #333; border-radius: 20px; font-size: 11px; color: #ccc; white-space: nowrap; cursor: pointer; flex-shrink: 0; }
        .chip:hover { background: #333; color: #fff; border-color: var(--primary); }

        .grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; align-content: start; }
        .card { background: #141414; border: 1px solid #222; border-radius: 6px; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; height: 100px; position: relative; }
        .card:hover { transform: translateY(-2px); border-color: var(--primary); }
        .c-img { flex: 1; background: radial-gradient(circle, #222, #000); display: flex; align-items: center; justify-content: center; position: relative; }
        .c-img img { max-width: 80%; max-height: 80%; object-fit: contain; z-index: 2; }
        .c-inf { height: 28px; padding: 0 6px; background: #1a1a1a; display: flex; align-items: center; justify-content: space-between; font-size: 10px; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: #050505; z-index: 2000; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .pdf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .pdf-card { background: #111; padding: 15px; border: 1px solid #333; text-align: center; cursor: pointer; color: #ccc; border-radius: 6px; }
        .pdf-card:hover { border-color: var(--primary); color: #fff; }

        /* Mobile */
        @media (max-width: 768px) {
            .app-body { flex-direction: column; }
            .sidebar { display: none; position: absolute; top: 0; bottom: 0; left: 0; width: 85%; z-index: 999; background: #0a0a0a; box-shadow: 2px 0 10px #000; }
            .sidebar.open { display: flex; }
            .mob-btn { display: block !important; position: absolute; top: 5px; left: 5px; z-index: 300; background: rgba(0,0,0,0.5); color: #fff; padding: 5px 10px; border: 1px solid #fff; border-radius: 4px; }
            .player-stage { height: 40vh; }
        }
        .mob-btn { display: none; }

    </style>
</head>
<body>

<button class="mob-btn" onclick="toggleSidebar()">‚ò∞</button>

<div class="ticker-box">
    <div class="t-lbl">J&K LIVE</div>
    <div class="t-wrap"><div class="t-txt" id="kashmirTicker">Loading Live Updates...</div></div>
</div>

<div class="app-body">
    <div class="sidebar" id="sidebar">
        <div class="brand">
            <div>DAR<span>TV</span></div>
            <button onclick="toggleSidebar()" style="margin-left:auto; background:none; border:none; color:#fff; font-size: 18px;">‚úï</button>
        </div>

        <div class="tools">
            <div class="mode-row">
                <div class="mode-btn active" id="btn-tv" onclick="setMode('tv')">üì∫ TV Mode</div>
                <div class="mode-btn" id="btn-radio" onclick="setMode('radio')">üìª Radio Mode</div>
            </div>

            <div class="btn-row">
                <button class="tool-btn" onclick="openModal('music')">Music</button>
                <button class="tool-btn" onclick="openModal('pdf')">PDF Tools</button>
                <button class="tool-btn" onclick="openModal('info')">Contact</button>
            </div>
            
            <div class="cors-toggle" onclick="toggleCors()"><span style="font-size:11px;">Unblock Stream</span><div class="cors-ind" id="corsInd"></div></div>
            
            <div class="btn-row">
                <button class="tool-btn" onclick="document.getElementById('localFile').click()">Upload</button>
                <button class="tool-btn" onclick="window.open('https://drive.google.com','_blank')">Drive</button>
            </div>
            <input type="file" id="localFile" style="display:none" onchange="handleFile(this)">
            
            <div class="btn-row">
                <input type="text" id="linkIn" class="inp" placeholder="Paste Link...">
                <button class="tool-btn" style="flex:0 0 40px;" onclick="loadLink()">GO</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="setTab('countries',this)">Countries</button>
                <button class="tab" onclick="setTab('languages',this)">Langs</button>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="sideSearch" class="inp" placeholder="Search List..." onkeyup="filterNav()">
        </div>
        <div class="nav-list" id="navList"></div>
    </div>

    <div class="main">
        <div class="player-stage">
            <div class="video-box">
                <div class="overlay-center" id="logoOverlay">
                    <div class="big-logo">DAR<span>TV</span></div>
                    <div class="loader"></div>
                    <div style="color:#aaa; font-size:12px; margin-top:10px;">WAITING FOR SIGNAL</div>
                </div>
                
                <video id="video" controls autoplay playsinline></video>
                
                <div id="radioViz" class="radio-viz">
                    <i class="fa-solid fa-music" style="font-size:60px; color:var(--primary);"></i>
                    <h2 id="radioName" style="color:#fff; margin-top:20px;">Playing Radio</h2>
                    <div class="viz-bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                </div>
            </div>
        </div>

        <div class="ticker-box" style="background:#0c4a6e; border-top:1px solid #333;">
            <div class="t-lbl t-blue">WORLD</div>
            <div class="t-wrap"><div class="t-txt tx-blue" id="worldTicker">Connecting...</div></div>
        </div>

        <div class="browser">
            <div class="controls">
                <div class="meta">
                    <img src="" id="metaImg" style="opacity:0">
                    <div class="meta-info"><div id="metaTitle">DarTV Live</div><div id="metaStat">Ready</div></div>
                </div>
                <div class="actions">
                    <select id="qualitySelect" class="quality-select" onchange="changeQuality(this.value)"></select>
                    
                    <button class="act-btn" onclick="reload()">‚Üª</button>
                    <button class="act-btn" onclick="toggleBoost()" id="boostBtn">üîä+</button>
                    <button class="act-btn" onclick="togglePiP()">üì∫</button>
                    <button class="act-btn" onclick="takeSnap()">üì∑</button>
                    <button class="act-btn" onclick="toggleRatio()">‚õ∂</button>
                </div>
            </div>
            
            <div class="rail" id="categories"></div>
            <input type="text" id="gridSearch" class="inp" placeholder="Search Grid..." onkeyup="filterGrid()" style="margin:5px 10px; width:auto; flex:1;">
            <div class="grid" id="grid"></div>
        </div>
    </div>
</div>

<div id="modal-info" class="modal">
    <div class="modal-head"><h2>Contact Us</h2><button class="tool-btn" style="width:auto;" onclick="closeModal()">CLOSE</button></div>
    <div style="background:#111; padding:20px; border-radius:8px; border:1px solid #333; max-width:600px; margin:0 auto;">
        <p><strong>Mobile:</strong> +91 7006686584</p>
        <p><strong>Email:</strong> darajazb@gmail.com</p>
        <hr style="border-color:#333; margin:15px 0;">
        <h3>Privacy Policy</h3>
        <p style="color:#ccc; font-size:13px;">DarTV aggregates streams. We do not host content.</p>
    </div>
</div>

<div id="modal-pdf" class="modal">
    <div class="modal-head"><h2>PDF24 Tools</h2><button class="tool-btn" style="width:auto;" onclick="closeModal()">CLOSE</button></div>
    <div class="pdf-grid" id="pdfGrid"></div>
</div>

<div id="modal-music" class="modal">
    <div class="modal-head"><h2>Music Player</h2><button class="tool-btn" style="width:auto;" onclick="closeModal()">CLOSE</button></div>
    <div style="text-align:center;">
        <div style="width:150px; height:150px; background:#222; border-radius:50%; margin:0 auto 20px; border:4px solid #333;"></div>
        <audio id="audioPlayer" controls style="width:100%; max-width:500px; margin-bottom:20px;"></audio>
        <div style="display:flex; gap:5px; max-width:500px; margin:0 auto;">
            <input type="text" id="musicLink" class="inp" placeholder="Paste Drive/MP3 Link...">
            <button class="tool-btn" style="width:auto;" onclick="playMusic()">PLAY</button>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let hls = null;
    let mode = 'tv'; 
    let cors = false;
    let activeList = 'countries';
    let audioCtx, source, gainNode, isBoosted=false;

    // --- FULL DATABASE RESTORED ---
    const DB_COUNTRIES = [
        {c:"in",n:"India"},{c:"pk",n:"Pakistan"},{c:"us",n:"USA"},{c:"gb",n:"UK"},{c:"sa",n:"Saudi Arabia"},{c:"ae",n:"UAE"},
        {c:"af",n:"Afghanistan"},{c:"bd",n:"Bangladesh"},{c:"cn",n:"China"},{c:"tr",n:"Turkey"},{c:"ru",n:"Russia"},{c:"de",n:"Germany"},
        {c:"fr",n:"France"},{c:"ca",n:"Canada"},{c:"au",n:"Australia"},{c:"jp",n:"Japan"},{c:"ir",n:"Iran"},{c:"id",n:"Indonesia"},
        {c:"br",n:"Brazil"},{c:"mx",n:"Mexico"},{c:"it",n:"Italy"},{c:"es",n:"Spain"},{c:"nl",n:"Netherlands"},{c:"za",n:"South Africa"},
        {c:"lk",n:"Sri Lanka"},{c:"np",n:"Nepal"},{c:"ph",n:"Philippines"},{c:"th",n:"Thailand"},{c:"vn",n:"Vietnam"},{c:"kr",n:"South Korea"},
        {c:"eg",n:"Egypt"},{c:"qa",n:"Qatar"},{c:"kw",n:"Kuwait"},{c:"om",n:"Oman"},{c:"bh",n:"Bahrain"},{c:"my",n:"Malaysia"},
        {c:"sg",n:"Singapore"},{c:"nz",n:"New Zealand"},{c:"pt",n:"Portugal"},{c:"se",n:"Sweden"},{c:"ch",n:"Switzerland"},
        {c:"no",n:"Norway"},{c:"dk",n:"Denmark"},{c:"fi",n:"Finland"},{c:"pl",n:"Poland"},{c:"ua",n:"Ukraine"},{c:"ro",n:"Romania"}
    ];
    
    const DB_LANG = [
        {c:"urd",n:"Urdu"},{c:"hin",n:"Hindi"},{c:"eng",n:"English"},{c:"ara",n:"Arabic"},{c:"kas",n:"Kashmiri"},
        {c:"pan",n:"Punjabi"},{c:"ben",n:"Bengali"},{c:"tam",n:"Tamil"},{c:"mal",n:"Malayalam"},{c:"tel",n:"Telugu"},
        {c:"spa",n:"Spanish"},{c:"fra",n:"French"},{c:"de",n:"German"},{c:"rus",n:"Russian"},{c:"zho",n:"Chinese"}
    ];

    const DB_CATS = [
        {id:"news",n:"News"},{id:"sports",n:"Sports"},{id:"movies",n:"Movies"},{id:"music",n:"Music"},
        {id:"kids",n:"Kids"},{id:"religious",n:"Religious"},{id:"documentary",n:"Documentary"},{id:"lifestyle",n:"Lifestyle"}
    ];

    window.onload = () => { 
        setMode('tv'); 
        startNews();
        renderPDF();
        
        let v = document.getElementById('video');
        // FIX: Ensure logo hides only when playing
        v.addEventListener('playing', () => document.getElementById('logoOverlay').classList.add('hidden'));
        v.addEventListener('waiting', () => document.getElementById('logoOverlay').classList.remove('hidden'));
    };

    // --- MODES ---
    function setMode(m) {
        mode = m;
        document.getElementById('btn-tv').classList.toggle('active', m==='tv');
        document.getElementById('btn-radio').classList.toggle('active', m==='radio');
        
        document.getElementById('video').style.display = m==='tv'?'block':'none';
        document.getElementById('radioViz').style.display = m==='radio'?'flex':'none';
        
        setTab('countries', document.querySelector('.tab'));
        
        if(m==='tv') {
            renderCats();
            document.getElementById('grid').innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Select Country for TV</div>';
        } else {
            document.getElementById('categories').innerHTML = ''; // Hide TV cats
            document.getElementById('grid').innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Select Country for Radio</div>';
        }
        if(window.innerWidth < 768) toggleSidebar();
    }

    // --- SIDEBAR ---
    function setTab(type, btn) {
        activeList = type;
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); if(btn)btn.classList.add('active');
        renderNav(type==='countries' ? DB_COUNTRIES : DB_LANG);
    }

    function renderNav(list) {
        const l = document.getElementById('navList'); l.innerHTML = '';
        list.forEach(i => {
            let e = document.createElement('div'); e.className = 'nav-item s-item'; e.setAttribute('data-q', i.n.toLowerCase());
            e.innerHTML = `<span class="fi fi-${i.c}"></span> ${i.n}`;
            e.onclick = () => {
                if(mode==='tv') loadTV(i.c, i.n);
                else loadRadio(activeList==='countries'?i.c:i.n, i.n); // Fixed Radio Logic
                if(window.innerWidth < 768) toggleSidebar();
            };
            l.appendChild(e);
        });
    }

    function renderCats() {
        const r = document.getElementById('categories'); r.innerHTML = '';
        if(mode !== 'tv') return;
        DB_CATS.forEach(c => {
            let e = document.createElement('div'); e.className = 'chip'; e.innerText = c.n;
            e.onclick = () => loadTV(c.id, c.n, true);
            r.appendChild(e);
        });
    }

    // --- TV LOAD (Optimized) ---
    async function loadTV(id, title, isCat=false) {
        setMeta("Loading...", title); 
        document.getElementById('logoOverlay').classList.remove('hidden');
        let url = isCat ? `https://iptv-org.github.io/iptv/categories/${id}.m3u` : `https://iptv-org.github.io/iptv/countries/${id}.m3u`;
        
        // SPEED FIX: Try direct first, fallback to proxy
        try {
            let res = await fetch(url);
            if(!res.ok) throw new Error();
            let txt = await res.text();
            parseM3U(txt); setMeta(title, "Loaded");
        } catch(e) {
            try {
                // Fallback to CORS proxy
                let res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
                let txt = await res.text();
                parseM3U(txt); setMeta(title, "Loaded via Proxy");
            } catch(ex) { setMeta("Error", "Failed to Load"); }
        }
    }

    function parseM3U(d) {
        let channels=[]; let lines=d.split('\n'), cur={};
        lines.forEach(l=>{
            l=l.trim();
            if(l.startsWith('#EXTINF:')) {
                let logo=l.match(/tvg-logo="([^"]*)"/); let n=l.split(',').pop();
                cur.name=n; cur.logo=logo?logo[1]:null;
            } else if(l.startsWith('http')) { cur.url=l; channels.push({...cur}); cur={}; }
        });
        renderGrid(channels, 'tv');
    }

    // --- RADIO LOAD (API) ---
    async function loadRadio(code, name) {
        setMeta("Scanning...", name);
        let query = activeList==='countries' ? `countrycode=${code}` : `language=${name}`;
        let url = `https://de1.api.radio-browser.info/json/stations/search?${query}&limit=300&hidebroken=true&order=clickcount`;
        
        try {
            let res = await fetch(url); let data = await res.json();
            renderGrid(data, 'radio'); setMeta(name, `${data.length} Stations`);
        } catch(e) { setMeta("Error", "Radio API Failed"); }
    }

    // --- GRID ---
    function renderGrid(list, type) {
        const g = document.getElementById('grid'); g.innerHTML = '';
        if(!list.length) g.innerHTML = '<div style="padding:20px;text-align:center;">No items found.</div>';
        
        list.forEach(item => {
            let e = document.createElement('div'); e.className = 'card';
            let name = item.name || "Unknown";
            e.setAttribute('data-name', name.toLowerCase());
            let img = type==='tv' ? (item.logo||'') : (item.favicon||'');
            let icon = type==='tv' ? 'fa-tv' : 'fa-music';
            let url = item.url || item.url_resolved; 
            
            e.innerHTML = `<div class="c-img"><i class="fa-solid ${icon}" style="font-size:30px;color:#333;position:absolute;"></i><img src="${img}" onerror="this.style.display='none'"></div><div class="c-inf"><div>${name.substring(0,20)}</div></div>`;
            e.onclick = () => { if(type==='tv') playChannel(url, name); else playRadio(url, name); };
            g.appendChild(e);
        });
    }

    // --- PLAYERS ---
    function playChannel(url, name) {
        let v = document.getElementById('video');
        document.getElementById('qualitySelect').style.display = 'none'; // Reset quality
        
        if (Hls.isSupported()) {
            if(hls) hls.destroy(); 
            hls = new Hls({ enableWorker: true, lowLatencyMode: true }); // SPEED CONFIG
            hls.loadSource(url); 
            hls.attachMedia(v);
            hls.on(Hls.Events.MANIFEST_PARSED, (e,d) => { 
                v.play(); 
                setupQuality(d.levels); // QUALITY FIX
            });
        } else if (v.canPlayType('application/vnd.apple.mpegurl')) { 
            v.src = url; v.play(); 
        }
        document.getElementById('metaTitle').innerText = name;
    }

    function playRadio(url, name) {
        let v = document.getElementById('video'); 
        if(hls) { hls.destroy(); hls=null; }
        v.src = url; v.play();
        document.getElementById('radioName').innerText = name;
        document.getElementById('metaTitle').innerText = name;
    }

    // --- EXTRAS ---
    function renderPDF() {
        const tools = ["Merge PDF", "Split PDF", "Compress PDF", "Edit PDF", "Sign PDF", "Converter", "Images to PDF", "Protect PDF", "Unlock PDF", "Rotate PDF", "Crop PDF", "Extract Pages", "Sort Pages", "Webpage to PDF"];
        const g = document.getElementById('pdfGrid');
        tools.forEach(t => {
            let e = document.createElement('div'); e.className = 'pdf-card';
            e.innerHTML = `<i class="fa-solid fa-file-pdf"></i><br>${t}`;
            e.onclick = () => window.open(`https://tools.pdf24.org/en/${t.toLowerCase().replace(/ /g,'-')}`, '_blank');
            g.appendChild(e);
        });
    }

    function playMusic() {
        let url = document.getElementById('musicLink').value;
        if(url.includes('drive.google.com')) {
            let id = url.match(/\/d\/(.+?)\//) || url.match(/id=(.+?)(&|$)/);
            if(id) url = `https://docs.google.com/uc?export=download&id=${id[1]}`;
        }
        document.getElementById('audioPlayer').src = url;
        document.getElementById('audioPlayer').play();
    }

    // --- UTILS ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function toggleCors() { cors = !cors; document.getElementById('corsInd').style.background = cors ? '#0f0' : '#444'; }
    function setMeta(t,s) { document.getElementById('metaTitle').innerText=t; document.getElementById('metaStat').innerText=s; }
    function openModal(id) { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); document.getElementById('modal-'+id).classList.add('active'); if(window.innerWidth<768) toggleSidebar(); }
    function closeModal() { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); }
    function reload() { let v=document.getElementById('video'); if(hls) hls.startLoad(); else v.load(); v.play(); }
    function fit() { let v=document.getElementById('video'); v.style.objectFit = v.style.objectFit==='cover'?'contain':'cover'; }
    function filterNav() { let q=document.getElementById('sideSearch').value.toLowerCase(); document.querySelectorAll('.s-item').forEach(x=>x.style.display=x.getAttribute('data-q').includes(q)?'flex':'none'); }
    function filterGrid() { let q=document.getElementById('gridSearch').value.toLowerCase(); document.querySelectorAll('.card').forEach(x=>x.style.display=x.getAttribute('data-name').includes(q)?'flex':'none'); }
    function handleFile(i) { let f=i.files[0]; if(!f)return; let u=URL.createObjectURL(f); if(f.name.endsWith('.m3u')){let r=new FileReader();r.onload=e=>parseM3U(e.target.result);r.readAsText(f);}else{playChannel(u,f.name);} }
    function loadLink() { let u=document.getElementById('extUrl').value; if(u.endsWith('.m3u')) loadTV(u,'External',false); else playChannel(u,'Stream'); }
    
    // QUALITY LOGIC (RESTORED)
    function setupQuality(levels) {
        const sel = document.getElementById('qualitySelect');
        if(levels && levels.length > 1) {
            sel.innerHTML = '<option value="-1">Auto</option>';
            levels.forEach((l,i) => sel.innerHTML += `<option value="${i}">${l.height}p</option>`);
            sel.style.display = 'block';
        } else sel.style.display = 'none';
    }
    function changeQuality(v) { if(hls) hls.currentLevel = parseInt(v); }
    function toggleBoost() {
        const v = document.getElementById('video');
        if(!audioCtx) { audioCtx = new (window.AudioContext||window.webkitAudioContext)(); source = audioCtx.createMediaElementSource(v); gainNode = audioCtx.createGain(); source.connect(gainNode); gainNode.connect(audioCtx.destination); }
        isBoosted = !isBoosted; gainNode.gain.value = isBoosted ? 3.0 : 1.0;
        document.getElementById('boostBtn').style.color = isBoosted?'#0f0':'#ccc';
    }
    async function togglePiP() { if(document.pictureInPictureElement) await document.exitPictureInPicture(); else await document.getElementById('video').requestPictureInPicture(); }
    function takeSnap() { const v=document.getElementById('video'); const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0); const a=document.createElement('a'); a.download='snap.png'; a.href=c.toDataURL(); a.click(); }

    // --- NEWS ---
    async function startNews() { updateNews(); setInterval(updateNews, 300000); }
    async function updateNews() {
        try {
            let res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=http://feeds.bbci.co.uk/news/world/rss.xml');
            let data = await res.json();
            document.getElementById('worldTicker').innerText = data.items.map(i=>`‚Ä¢ ${i.title}`).join(' ');
            document.getElementById('kashmirTicker').innerText = "‚Ä¢ ‚ö†Ô∏è J&K LIVE: Srinagar Cold Wave ‚Ä¢ Traffic on NH-44 Normal ‚Ä¢ Schools Reopen in Valley ‚Ä¢ Contact us for Live Reporting ‚Ä¢";
        } catch(e) {}
    }
</script>
</body>
</html>
